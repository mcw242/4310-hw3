<html>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <style>
            .filter {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                padding-left: 10px;
            }

            #top {
                height: 200px;
                text-align: center;
            }

            #panel {
                height: 100px;
                width: 300px;
                position: absolute;
                left: 20;
                top: 200;
                padding: 0 0 20 15;
            }

            h1 {
                font-size: 40px;
                padding-top: 50px;
                margin-bottom: 0px;
                padding-bottom: 0px;
            }

            h2, h3, p {
                padding-left: 10px;
            }

            h3 {
                margin-bottom: 5px;
                margin-top: 0px;
            }

            h2 {
                margin-bottom: 0px;
            }

            p {
                text-align: left;
                font-size: 18px;
                font-style: italic;
                margin-top: 5px;
            }

            #filters {
                position: absolute;
                height: 900px;
                width: 400px;
                top: 200px;
                left: 1100px;
                border: 2px solid black;
            }

            .neighborhoodFilters {
                position: absolute;
                top: 269px;
                left: 200px;
            }

            #neighborhoodHeading {
                position: absolute;
                top: 242px;
                left: 200px;
            }

            #selectAll {
                position: absolute;
                top: 850px;
                left: 10px;
            }

            #deselectAll {
                position: absolute;
                top: 850px;
                left: 85px;
            }

            #saveForLater {
                position: absolute;
                height: 500px;
                width: 1400px;
                top: 1125px;
                left: 100px;
                border: 2px solid black;
            }

            .bold {
                font-weight: bold;
            }

        </style>
    </head>
    <body>
        <div id="top">
            <h1>Pittsburgh Food & Leisure</h1>
            <h3>Cameron Kull (cak264) & Marie Williams (mcw242)</h3>
        </div>
        <svg id="map" width = 1100 height = 825></svg>
        <!-- style = background-color:#d6d6d6 -->
        <div id="panel"></div>

        <div id="filters">
            <h2>Tailor Your Search</h2>
            <p>Hover over an establishment to learn more about it, and click if you want to "save"
            the restaurant as an option for later!</p>
            <h3>By Rating</h3>
            <svg id="rating" width = 400 height = 80></svg>
            <h3>By Category</h3>
            <h3 id="neighborhoodHeading">By Neighborhood</h3>
            <button id="selectAll">Select All</button>
            <button id="deselectAll">Deselect All</button>
        </div>

        <div id="saveForLater">
            <h2>Save for Later</h2>
            <p>Review the details of your saved establishments and compare them to aid in your decision.</p>
            <svg id="svgSave" width="1400" height="500px"></svg>
        </div>

        <script>
            // constants
            const svg = d3.select("#map");
            const mapWidth = svg.attr("width");
            const mapHeight = svg.attr("height");
            let map = svg.append("g");
            let viewport = svg.append("g");

            // map setup
            const requestData = async function(){
                const pittsburgh = await d3.json("pittsburgh.geojson");
                console.log(pittsburgh);

                let yelps = await d3.csv("yelp_pittsburgh.csv", d3.autoType);
                yelps.forEach(function(entry) {
                    entry.category = entry.category.charAt(0).toUpperCase() + entry.category.slice(1)
                    if (entry.category === 'Ethnicmarkets') {entry.category = 'Ethnic Market';}
                    if (entry.category === 'Indpak') {entry.category = 'Indo-Pak';}
                    if (entry.category === 'Newamerican') {entry.category = 'New American';}
                });

                //filtering out restaurants outside of map
                var excludedNames = ["Ou's International", "Biddle's Escape", 'Triangle Bar & Grill', 'Curry Away',
                'Root 174','A & B Doughnuts','Me Lyng Restaurant','Asian House','Everest Ethnic Restaurant',
                "Jean-Marc Chatellier's French Bakery","Hog's Head Bar & Grill",'Sapporo Japanese Steakhouse',
                'Chan An Restaurant',"Sarafino's Pasta and Pizza","Big Daddy's Donuts",'Cafe Delhi','Kasai',
                'Mad Mex - South Hills','Red Tea House','Cafe io','Hollywood Theater','Amazing Wok','Thai Spoon',
                'Katana','Il Pizzaiolo','Jade Grille','Arancini House','Little Tokyo', 'Tamarind Savoring India',
                'Thai Cottage', 'Manpasand Spice Corner',"Parker's PGH",'Fredos Deli', "Big Shot Bob's House of Wings", 
                "Hog's Head Bar & Grill", 'North Hills Grill', 'Schorr Bakery', "Yeung's House"];

                var filteredYelps = yelps.filter(function(entry) {
                    return !excludedNames.includes(entry.name);
                });

                filteredYelps = filteredYelps.filter(y=> y.neighborhood != null);
                console.log(filteredYelps);

                //trees = trees.filter(t=> t.DBH != null && t.DBH >=5 && t.qLegalStatus!= null);

                // var stores = topojson.feature(pittsburgh, pittsburgh);
                // var neighborhoodsMesh = topojson.mesh(sanfran, sanfran.objects.SFNeighborhoods);
                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], pittsburgh);
                var path = d3.geoPath().projection(projection);


                // construct the visualization
                map.selectAll("path.main").data(pittsburgh.features)
                    .join("path")
                    .attr("class", "main")
                    .attr("d", path)
                    .attr('fill', '#e6e6e6');

                map.selectAll("path.neighborhoods").data(pittsburgh.features)
                    .join("path")
                    .attr("class", "neighborhoods")
                    .attr("d", path)
                    .attr('fill', 'none')
                    .attr("stroke", "black")
                    .attr("stroke-width", 1);

                // add circles

                let colorScale = d3.scaleOrdinal(d3.schemeTableau10);

                viewport.selectAll("circle").data(filteredYelps)
                        .join("circle")
                        .attr("cx", y=> projection([y.longitude, y.latitude])[0])
                        .attr("cy", y=> projection([y.longitude, y.latitude])[1])
                        .attr("r", 6)
                        .attr("fill", y=> colorScale(y.type))
                        .attr("opacity", 0.65);

                // hovering
                let allStores = viewport.selectAll("circle");

                allStores.on("mouseover", function(event, d) {

                    d3.select(this)
                        .raise()
                        .transition().duration(100)
                        .attr("stroke","black")
                        .attr("stroke-width", 3)
                        .attr("opacity", 1)
                        .attr('r', 10);

                    updatePanel(d);

                });

                allStores.on("mouseout", function(event, d) {

                  d3.select(this)
                    .transition().duration(200)
                    .attr("stroke","")
                    .attr("stroke-width", 0)
                    .attr('r',6)
                    .attr("opacity", 0.65);

                  table.selectAll("tr").remove();

                });

                let panel = d3.select("#panel").append("h3");
                let table = panel.append("table");

                function updatePanel(row) {
                    let rowCopy = Object.assign({},row);

                    let name = rowCopy.name;
                    // panel.text(name);

                    let keysToKeep = ['name','rating', 'category'];

                    let kvPairs = keysToKeep.map(key => {
                        let value = rowCopy[key];
                        return [key, value];
                    });

                    table.selectAll("tr").remove();

                    let rows = table.selectAll("tr").data(kvPairs)
                        .enter()
                        .append("tr");

                    rows.append("td")
                    .text(function(d) {
                        if (d[0] === 'rating') {
                            return d[1] + '/5 Stars';
                        } else {
                            return d[1];
                        }
                    })
                    .style("font-size", function(d, i) {
                        return i === 0 ? "20px" : "16px";
                    })
                    .style("font-weight", function(d, i) {
                        return i === 0 ? "bold" : "none";
                    });


                };


                // filters
                let filters = d3.select("#filters");

                let categories = [];
                filteredYelps.forEach(place=>{
                    if (categories.includes(place.category)==false){
                        categories.push(place.category)
                    };
                });
                categories.sort();

                let neighborhoods = [];
                filteredYelps.forEach(place=>{
                    if (neighborhoods.includes(place.neighborhood)==false){
                        neighborhoods.push(place.neighborhood)
                    };
                });
                neighborhoods.sort();


                let categoryFilters = filters.append("g");
                let filterID = 0;
                categories.forEach(category=>{
                    let filterBlock = categoryFilters.append("g")
                                                     .attr("class", "filter");
                    filterBlock.append("input")
                               .attr("type", "checkbox")
                               .attr("id", "a"+filterID.toString())
                               .attr("class", "categoryCheckbox")
                               .property("checked", true);
                    filterBlock.append("label")
                               .attr("for", "a"+filterID.toString())
                               .attr("class", "a"+filterID.toString())
                               .text(category);
                    filterID+=1;
                });

                let neighborhoodFilters = filters.append("g")
                                                .attr("transform", `translate(${10}, ${10})`)
                                                .attr("class", "neighborhoodFilters");
                neighborhoods.forEach(neighborhood=>{
                    let filterBlock = neighborhoodFilters.append("g")
                                                     .attr("class", "filter");
                    filterBlock.append("input")
                               .attr("type", "checkbox")
                               .attr("id", "a"+filterID.toString())
                               .attr("class", "neighborhoodCheckbox")
                               .property("checked", true);
                    filterBlock.append("label")
                               .attr("for", "a"+filterID.toString())
                               .attr("class", "a"+filterID.toString())
                               .text(neighborhood);
                    filterID+=1;
                });

                let uncheckedFilters = [];

                function updateCategoryFilter(){
                    var checkboxId = d3.select(this).attr("id");
                    var isChecked = d3.select(this).property("checked");
                    var categoryLabel = d3.select("label."+checkboxId).text();

                    if (isChecked) {
                        handleCheckboxChecked(categoryLabel);
                    } else {
                        handleCheckboxUnchecked(categoryLabel);
                    }
                };

                function updateNeighborhoodFilter(){
                    var checkboxId = d3.select(this).attr("id");
                    var isChecked = d3.select(this).property("checked");
                    var neighborhoodLabel = d3.select("label."+checkboxId).text();

                    if (isChecked) {
                        handleCheckboxChecked(neighborhoodLabel);
                    } else {
                        handleCheckboxUnchecked(neighborhoodLabel);
                    }
                };

                // Function to handle checkbox checked event
                function handleCheckboxChecked(input) {
                    for (let i = 0; i < uncheckedFilters.length; i++) { 
                        if (uncheckedFilters[i] === input) { 
                            uncheckedFilters.splice(i, 1); 
                        }
                    }
                
                    allStores.each(function(s) {
                        if (uncheckedFilters.includes(s.category) || uncheckedFilters.includes(s.neighborhood)){
                        }
                        else if (s.category == input){
                            d3.select(this)
                              .transition().duration(200)
                              .attr("r", 6);
                        }
                        else if (s.neighborhood == input){
                            d3.select(this)
                              .transition().duration(200)
                              .attr("r", 6);
                        };
                    
                    })

                };

                // Function to handle checkbox unchecked event
                function handleCheckboxUnchecked(input) {

                    uncheckedFilters.push(input);
        
                    allStores.each(function(s) {

                        if (s.category == input){
                            d3.select(this)
                              .transition().duration(200)
                              .attr("r", 0);
                        }
                        else if (s.neighborhood == input){
                            d3.select(this)
                              .transition().duration(200)
                              .attr("r", 0);
                        };
                    })
                };

                // function selectAllButton(id){
                    
                //     if (id == "selectAll"){
                //         d3.selectAll("input[type='checkbox']").property("checked", true);
                //         d3.selectAll("circle")
                //             .transition().duration(200)
                //             .attr("r", 6);
                        
                //     }
                //     else{
                //         // let boxes = d3.selectAll("input[type='checkbox']");
                //         // console.log(typeof(boxes));
                //         // boxes.each(function() {
                //         //     let boxID = this.id;
                //         //     let label = d3.select("label."+ boxID);
                //         //     handleCheckboxUnchecked(label);
                //         //     // list.push(label.text());
                //         // });
                //         d3.selectAll("input[type='checkbox']").property("checked", false);
                //         d3.selectAll("circle")
                //             .transition().duration(200)
                //             .attr("r", 0);
                //     }
                //};

                d3.selectAll("input[type='checkbox']").on("click", updateCategoryFilter);
                d3.selectAll("input[type='checkbox']").on("click", updateNeighborhoodFilter);

                d3.select("button#selectAll").on("click", function(){
                    let boxes = d3.selectAll("input[type='checkbox']").property("checked", true);
                    boxes.each(function() {
                        let boxID = this.id;
                        let label = d3.select("label."+ boxID);
                        handleCheckboxChecked(label.text());
                    })
                });
                d3.select("button#deselectAll").on("click", function(){
                    let boxes = d3.selectAll("input[type='checkbox']").property("checked", false);
                    boxes.each(function() {
                            let boxID = this.id;
                            let label = d3.select("label."+ boxID);
                            handleCheckboxUnchecked(label.text());
                    })
                });

                // make 'save for later' function
                function saveForLater(d){
                    var savedBox = d3.select("svg#svgSave").append("g");
                    savedBox.append("rect")
                            .attr("x", 20)
                            .attr("y", 30)
                            .attr("height", 350)
                            .attr("width", 300)
                            .attr("fill", 'none')
                            .attr("stroke", "black");

                    let dCopy = Object.assign({},d);

                    let keysToKeep = ['name', 'rating', 'category', 'neighborhood', 'review count', 'url'];
                    let keyMappings = {
                        'rating': 'Rating',
                        'category': 'Category',
                        'name': 'Name',
                        'neighborhood': 'Neighborhood',
                        'review count': 'Review Count',
                        'url': 'Website'
                    };

                    let kvPairs = keysToKeep
                        .map(key => {
                            let value = dCopy[key];
                            // if (key === 'pclass') {
                            //     value = convertPclass(value);
                            // }
                            // else if (key === 'survived'){
                            //     value = convertSurvived(value);
                            // }
                            return [keyMappings[key], value];
                        })
                        .filter(([key, value]) => value !== null);

                    console.log(kvPairs);


                    savedBox.append("g").attr("class", "keys");
                    savedBox.append("g").attr("class", "values");

                    var xPos = 30;
                    var yPos = 90

                    kvPairs.forEach(function(x) {
                        
                        d3.select("g.keys").append("text")
                                           .attr("class", "bold")
                                           .text(x[0])
                                           .attr("x", xPos)
                                           .attr("y", yPos);

                        d3.select("g.values").append("text")
                                           .text(x[1])
                                           .attr("x", xPos+110)
                                           .attr("y", yPos);
                        
                        yPos+=40;
                    });
                };
                
                allStores.on("click", function(d){
                    let clickedOn = d3.select(this).datum();
                    saveForLater(clickedOn);
                });
            };

            


            requestData();
            

        </script>
    </body>
</html>
