<html>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>

        <style>
            .filter {
                display: flex;
                flex-direction: row;
                align-items: flex-start;
                padding-left: 10px;
            }

            #top {
                height: 200px;
                text-align: center;
            }

            #panel {
                height: 100px;
                width: 300px;
                position: absolute;
                left: 20;
                top: 200;
                padding: 0 0 20 15;
            }

            h1 {
                font-size: 40px;
                padding-top: 50px;
                margin-bottom: 0px;
                padding-bottom: 0px;
            }

            h2, h3, p {
                padding-left: 10px;
            }

            h3 {
                margin-bottom: 5px;
                margin-top: 0px;
            }

            h2 {
                margin-bottom: 0px;
            }

            p {
                text-align: left;
                font-size: 18px;
                font-style: italic;
                margin-top: 5px;
            }

            #filters {
                position: absolute;
                height: 800px;
                width: 400px;
                top: 200px;
                left: 1100px;
                border: 2px solid black;
            }

        </style>
    </head>
    <body>
        <div id="top">
            <h1>Pittsburgh Food & Leisure</h1>
            <h3>Cameron Kull (cak264) & Marie Williams (mcw242)</h3>
        </div>
        <svg id="map" width = 1100 height = 825></svg>
        <!-- style = background-color:#d6d6d6 -->
        <div id="panel"></div>

        <div id="filters">
            <h2>Tailor Your Search</h2>
            <p>Hover over an establishment to learn more about it, and click if you want to "save"
            the restaurant as an option for later!</p>
            <h3>By Rating</h3>
            <svg id="rating" width = 400 height = 80></svg>
            <h3>By Category</h3>
        </div>

        <script>
            // constants
            const svg = d3.select("#map");
            const mapWidth = svg.attr("width");
            const mapHeight = svg.attr("height");
            let map = svg.append("g");
            let viewport = svg.append("g");

            // map setup
            const requestData = async function(){
                const pittsburgh = await d3.json("pittsburgh.geojson");
                console.log(pittsburgh);

                let yelps = await d3.csv("yelp_pittsburgh.csv", d3.autoType);
                yelps.forEach(function(entry) {
                    entry.category = entry.category.charAt(0).toUpperCase() + entry.category.slice(1)
                    if (entry.category === 'Ethnicmarkets') {entry.category = 'Ethnic Market';}
                    if (entry.category === 'Indpak') {entry.category = 'Indo-Pak';}
                    if (entry.category === 'Newamerican') {entry.category = 'New American';}
                });

                //filtering out restaurants outside of map
                var excludedNames = ["Ou's International", "Biddle's Escape", 'Triangle Bar & Grill', 'Curry Away',
                'Root 174','A & B Doughnuts','Me Lyng Restaurant','Asian House','Everest Ethnic Restaurant',
                "Jean-Marc Chatellier's French Bakery","Hog's Head Bar & Grill",'Sapporo Japanese Steakhouse',
                'Chan An Restaurant',"Sarafino's Pasta and Pizza","Big Daddy's Donuts",'Cafe Delhi','Kasai',
                'Mad Mex - South Hills','Red Tea House','Cafe io','Hollywood Theater','Amazing Wok','Thai Spoon',
                'Katana','Il Pizzaiolo','Jade Grille','Arancini House','Little Tokyo', 'Tamarind Savoring India',
                'Thai Cottage', 'Manpasand Spice Corner',"Parker's PGH",'Fredos Deli'];

                var filteredYelps = yelps.filter(function(entry) {
                    return !excludedNames.includes(entry.name);
                });

                //trees = trees.filter(t=> t.DBH != null && t.DBH >=5 && t.qLegalStatus!= null);

                // var stores = topojson.feature(pittsburgh, pittsburgh);
                // var neighborhoodsMesh = topojson.mesh(sanfran, sanfran.objects.SFNeighborhoods);
                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], pittsburgh);
                var path = d3.geoPath().projection(projection);


                // console.log(topojson.feature(pittsburgh, pittsburgh))

                // construct the visualization
                map.selectAll("path.main").data(pittsburgh.features)
                    .join("path")
                    .attr("class", "main")
                    .attr("d", path)
                    .attr('fill', '#e6e6e6');

                map.selectAll("path.neighborhoods").data(pittsburgh.features)
                    .join("path")
                    .attr("class", "neighborhoods")
                    .attr("d", path)
                    .attr('fill', 'none')
                    .attr("stroke", "black")
                    .attr("stroke-width", 1);

                // add circles

                let colorScale = d3.scaleOrdinal(d3.schemeTableau10);
                console.log(colorScale("food"));

                viewport.selectAll("circle").data(filteredYelps)
                        .join("circle")
                        .attr("cx", y=> projection([y.longitude, y.latitude])[0])
                        .attr("cy", y=> projection([y.longitude, y.latitude])[1])
                        .attr("r", 6)
                        .attr("fill", y=> colorScale(y.type))
                        .attr("opacity", 0.65);

                // hovering
                let allStores = viewport.selectAll("circle");

                allStores.on("mouseover", function(event, d) {

                    d3.select(this)
                        .raise()
                        .transition().duration(100)
                        .attr("stroke","black")
                        .attr("stroke-width", 3)
                        .attr("opacity", 1)
                        .attr('r', 10);

                    updatePanel(d);

                });

                allStores.on("mouseout", function(event, d) {

                  d3.select(this)
                    .transition().duration(200)
                    .attr("stroke","")
                    .attr("stroke-width", 0)
                    .attr('r',6)
                    .attr("opacity", 0.65);

                  table.selectAll("tr").remove();

                });

                let panel = d3.select("#panel").append("h3");
                let table = panel.append("table");

                function updatePanel(row) {
                    let rowCopy = Object.assign({},row);

                    let name = rowCopy.name;
                    // panel.text(name);

                    let keysToKeep = ['name','rating', 'category'];

                    let kvPairs = keysToKeep.map(key => {
                        let value = rowCopy[key];
                        return [key, value];
                    });

                    table.selectAll("tr").remove();

                    let rows = table.selectAll("tr").data(kvPairs)
                        .enter()
                        .append("tr");

                    rows.append("td")
                    .text(function(d) {
                        if (d[0] === 'rating') {
                            return d[1] + '/5 Stars';
                        } else {
                            return d[1];
                        }
                    })
                    .style("font-size", function(d, i) {
                        return i === 0 ? "20px" : "16px";
                    })
                    .style("font-weight", function(d, i) {
                        return i === 0 ? "bold" : "none";
                    });


                };


                // filters
                let filters = d3.select("#filters");

                let categories = [];
                yelps.forEach(place=>{
                    if (categories.includes(place.category)==false){
                        categories.push(place.category)
                    };
                });
                categories.sort();


                let categoryFilters = filters.append("g");
                let filterID = 0;
                categories.forEach(category=>{
                    let filterBlock = categoryFilters.append("g")
                                                     .attr("class", "filter");
                    filterBlock.append("input")
                               .attr("type", "checkbox")
                               .attr("id", "a"+filterID.toString())
                               .attr("class", "checkbox");
                    filterBlock.append("label")
                               .attr("for", "a"+filterID.toString())
                               .attr("class", "a"+filterID.toString())
                               .text(category);
                    filterID+=1;
                });

                function updateFilter(){
                    var checkboxId = d3.select(this).attr("id");
                    var isChecked = d3.select(this).property("checked");

                    if (isChecked) {
                        handleCheckboxChecked(checkboxId);
                    } else {
                        handleCheckboxUnchecked(checkboxId);
                    }
                };

                // Function to handle checkbox checked event
                function handleCheckboxChecked(checkboxId) {
                    console.log("Checkbox with id " + checkboxId + " was checked.");
                    // Perform actions when checkbox is checked
                };

                // Function to handle checkbox unchecked event
                function handleCheckboxUnchecked(checkboxId) {
                    console.log("Checkbox with id " + checkboxId + " was unchecked.");
                    // Perform actions when checkbox is unchecked
                };

                d3.selectAll("input[type='checkbox']").on("click", updateFilter);



            };

            requestData();

        </script>
    </body>
</html>
